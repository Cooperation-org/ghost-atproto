generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String           @id @default(cuid())
  email                   String           @unique
  name                    String?
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
  blueskyHandle           String?          @map("bluesky_handle")
  blueskyPassword         String?          @map("bluesky_password")
  blueskyDid              String?
  ghostApiKey             String?          @map("ghost_api_key")
  ghostUrl                String?          @map("ghost_url")
  ghostWebhookId          String?          @map("ghost_webhook_id")
  ghostContentApiKey      String?          @map("ghost_content_api_key")
  blueskyMemberId         String?          @map("bluesky_member_id")
  shimUrl                 String?          @map("shim_url")
  shimSecret              String?          @map("shim_secret")
  password                String
  role                    Role             @default(USER)
  autoSync                Boolean          @default(true) @map("auto_sync")
  reviewedCivicActions    CivicAction[]    @relation("ReviewedActions")
  recommendedCivicActions CivicAction[]    @relation("RecommendedActions")
  submittedCivicActions   CivicAction[]    @relation("SubmittedActions")
  engagements             UserEngagement[]
  oauthSessions           OAuthSession[]
  posts                   Post[]
  syncLogs                SyncLog[]

  @@map("users")
}

model OAuthSession {
  id           String   @id @default(cuid())
  userId       String
  accessToken  String   @db.Text
  refreshToken String   @db.Text
  tokenType    String   @default("DPoP")
  dpopKeyJwk   String   @db.Text
  sub          String
  scope        String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "oauth_sessions_userId_fkey")
  @@map("oauth_sessions")
}

model Post {
  id              String           @id @default(cuid())
  title           String
  content         String           @db.Text
  excerpt         String?          @db.Text
  slug            String
  status          String           @default("draft")
  featureImage    String?
  ghostId         String?          @unique
  ghostSlug       String?
  ghostUrl        String?
  atprotoUri      String?
  atprotoCid      String?
  publishedAt     DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  userId          String
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  commentMappings CommentMapping[]

  @@index([userId], map: "posts_userId_fkey")
  @@map("posts")
}

model SyncLog {
  id         String   @id @default(cuid())
  action     String
  status     String
  source     String
  target     String
  postId     String?
  ghostId    String?
  atprotoUri String?
  error      String?  @db.Text
  retryCount Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "sync_logs_userId_fkey")
  @@map("sync_logs")
}

model CommentMapping {
  id               String   @id @default(cuid())
  bskyReplyUri     String   @unique @map("bsky_reply_uri")
  ghostCommentId   String   @map("ghost_comment_id")
  postId           String   @map("post_id")
  bskyAuthorDid    String?  @map("bsky_author_did")
  bskyAuthorHandle String?  @map("bsky_author_handle")
  createdAt        DateTime @default(now())
  post             Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@map("comment_mappings")
}

model Settings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
}

model CivicAction {
  id              String            @id @default(cuid())
  title           String
  description     String            @db.Text
  eventType       String?           @map("event_type")
  location        String?           @db.Text
  eventDate       DateTime?         @map("event_date")
  status          String            @default("pending")
  isPinned        Boolean           @default(false) @map("is_pinned")
  isVirtual       Boolean?          @map("is_virtual")
  deletedAt       DateTime?         @map("deleted_at")
  priority        Int               @default(0)
  recommendedBy   String?           @map("recommended_by")
  reviewedBy      String?           @map("reviewed_by")
  reviewedAt      DateTime?         @map("reviewed_at")
  rejectionReason String?           @map("rejection_reason") @db.Text
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  userId          String
  imageUrl        String?           @map("image_url") @db.LongText
  source          String            @default("user_submitted")
  externalId      String?           @map("external_id")
  externalUrl     String?           @map("external_url")
  sourceMeta      Json?             @map("source_meta")
  state           String?
  zipcode         String?
  engagements     UserEngagement[]
  reviewer        User?             @relation("ReviewedActions", fields: [reviewedBy], references: [id])
  recommender     User?             @relation("RecommendedActions", fields: [recommendedBy], references: [id])
  user            User              @relation("SubmittedActions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([source, externalId])
  @@index([reviewedBy], map: "civic_actions_reviewed_by_fkey")
  @@index([userId], map: "civic_actions_userId_fkey")
  @@index([recommendedBy], map: "civic_actions_recommended_by_fkey")
  @@index([state])
  @@index([zipcode])
  @@index([externalId])
  @@index([isVirtual])
  @@index([deletedAt])
  @@index([priority])
  @@fulltext([title, description])
  @@map("civic_actions")
}

model UserEngagement {
  id            String       @id @default(cuid())
  userId        String       @map("user_id")
  civicActionId String       @map("civic_action_id")
  status        String       @default("interested")
  notes         String?      @db.Text
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  civicAction   CivicAction  @relation(fields: [civicActionId], references: [id], onDelete: Cascade)

  @@unique([userId, civicActionId])
  @@index([userId], map: "user_engagements_user_id_fkey")
  @@index([civicActionId], map: "user_engagements_civic_action_id_fkey")
  @@map("user_engagements")
}

enum Role {
  USER
  AUTHOR
  ADMIN
}
