name: Deploy to Development

on:
  push:
    branches: [main]

concurrency:
  group: deploy-dev
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Dev Server
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10m
          script: |
            sudo su - civicsky << 'DEPLOY'
            set -euo pipefail
            
            log() { echo "[$(date +'%H:%M:%S')] $*"; }
            
            log "üöÄ Deploying..."
            cd ~/ghost-atproto/ghost-atproto-fullstack || { log "‚ùå Failed to cd to project directory"; exit 1; }
            log "Current directory: $(pwd)"
            
            # Save for rollback
            PREV=$(git rev-parse HEAD)
            log "Previous commit: $PREV"
            
            # Deploy
            git pull origin main
            rm -rf frontend/.next backend/dist
            
            # Backend
            log "Backend..."
            cd backend || { log "‚ùå Failed to cd to backend"; exit 1; }
            npm install || { log "‚ùå Backend npm install failed"; exit 1; }
            npx prisma generate || { log "‚ùå Prisma generate failed"; exit 1; }
            npm run build || { log "‚ùå Backend build failed"; exit 1; }
            pm2 restart atproto-backend 2>/dev/null || pm2 start dist/index.js --name atproto-backend || { log "‚ùå Failed to start backend"; exit 1; }
            log "‚úÖ Backend started/restarted"
            
            # Frontend
            log "Frontend..."
            cd ../frontend || { log "‚ùå Failed to cd to frontend"; exit 1; }
            log "Frontend directory: $(pwd)"
            npm install || { log "‚ùå Frontend npm install failed"; exit 1; }
            npm run build || { log "‚ùå Frontend build failed"; exit 1; }
            FRONTEND_DIR=$(pwd)
            pm2 restart atproto-frontend 2>/dev/null || (cd "$FRONTEND_DIR" && pm2 start npm --name atproto-frontend -- start) || { log "‚ùå Failed to start frontend"; exit 1; }
            log "‚úÖ Frontend started/restarted"
            
            pm2 save
            log "‚úÖ PM2 config saved"
            
            # Health check
            log "Checking health..."
            sleep 10
            for i in {1..6}; do
              if curl -sf http://localhost:5000/api/health >/dev/null 2>&1; then
                log "‚úÖ Health check passed!"
                exit 0
              fi
              log "‚è≥ Health check attempt $i/6 failed, retrying..."
              sleep 5
            done
            log "‚ùå Health check failed after 6 attempts"
            
            # Rollback
            log "‚ùå Failed - rolling back..."
            cd ~/ghost-atproto/ghost-atproto-fullstack
            git reset --hard $PREV
            cd backend && npm run build && pm2 restart atproto-backend
            cd ../frontend && npm run build && pm2 restart atproto-frontend
            exit 1
            
            DEPLOY
