name: Deploy to Development

on:
  push:
    branches: [main]

concurrency:
  group: deploy-dev
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Dev Server
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10m
          script: |
            sudo su - civicsky << 'DEPLOY'
            set -euo pipefail
            
            log() { echo "[$(date +'%H:%M:%S')] $*"; }
            
            log "üöÄ Deploying..."
            cd ~/ghost-atproto/ghost-atproto-fullstack
            
            # Save for rollback
            PREV=$(git rev-parse HEAD)
            
            # Deploy
            git pull origin main
            rm -rf frontend/.next backend/dist
            
            # Backend
            log "Backend..."
            cd ghost-atproto-fullstack/backend
            npm ci --prefer-offline
            npx prisma generate
            npm run build
            pm2 restart atproto-backend 2>/dev/null || pm2 start dist/index.js --name atproto-backend
            
            # Frontend
            log "Frontend..."
            cd ../frontend
            npm ci --prefer-offline
            npm run build
            pm2 restart atproto-frontend 2>/dev/null || pm2 start npm --name atproto-frontend -- start
            
            pm2 save
            
            # Health check
            log "Checking health..."
            sleep 10
            for i in {1..6}; do
              if curl -sf http://localhost:5000/api/health >/dev/null; then
                log "‚úÖ Success!"
                exit 0
              fi
              sleep 5
            done
            
            # Rollback
            log "‚ùå Failed - rolling back..."
            cd ~/ghost-atproto/ghost-atproto-fullstack
            git reset --hard $PREV
            cd backend && npm run build && pm2 restart atproto-backend
            cd ../frontend && npm run build && pm2 restart atproto-frontend
            exit 1
            
            DEPLOY
