name: Deploy to Development

on:
  push:
    branches: [main]

concurrency:
  group: deploy-dev
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Dev Server
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 10m
          script: |
            set -euo pipefail

            log() { echo "[$(date +'%H:%M:%S')] $*"; }

            log "üöÄ Deploying..."
            cd ~/ghost-atproto/ghost-atproto-fullstack
            
            # Save for rollback
            PREV=$(git rev-parse HEAD)
            
            # Deploy
            git pull origin main
            rm -rf frontend/.next backend/dist
            
            # Backend
            log "Backend..."
            cd backend
            npm install
            npx prisma migrate deploy
            npx prisma generate
            npm run build
            pm2 ping >/dev/null 2>&1 || pm2 resurrect 2>/dev/null || true
            pm2 delete atproto-backend 2>/dev/null || true
            pm2 start dist/server.js --name atproto-backend
            
            # Frontend
            log "Frontend..."
            cd ../frontend
            npm install
            npm run build
            pm2 delete atproto-frontend 2>/dev/null || true
            pm2 start npm --name atproto-frontend -- start
            
            pm2 save
            
            # Health check
            log "Checking health..."
            sleep 10
            
            HEALTH_PASSED=0
            for i in {1..6}; do
              if curl -sf http://localhost:5000/api/health >/dev/null 2>&1; then
                log "‚úÖ Health check passed!"
                HEALTH_PASSED=1
                break
              fi
              log "‚è≥ Attempt $i/6..."
              sleep 5
            done
            
            if [ $HEALTH_PASSED -eq 0 ]; then
              log "‚ùå Health check failed - rolling back..."
              cd ~/ghost-atproto/ghost-atproto-fullstack
              git reset --hard $PREV
              cd backend && npm run build && pm2 restart atproto-backend
              cd ../frontend && npm run build && pm2 restart atproto-frontend
              exit 1
            fi
            
            log "üéâ Deployment successful!"
